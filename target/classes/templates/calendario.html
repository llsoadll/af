<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Calendario Académico</title>
    <style>
        /* SweetAlert2 Custom Styles */
        .swal2-popup.swal2-modal {
            border-radius: 15px !important;
            padding: 2rem !important;
            background-color: #fff !important;
        }

        .swal2-title.swal2-title {
            color: #2c3e50 !important;
            font-size: 1.8em !important;
            margin-bottom: 1.5rem !important;
        }

        .swal2-input.swal2-input, 
        .swal2-textarea.swal2-textarea {
            border: 1px solid #e0e0e0 !important;
            border-radius: 8px !important;
            padding: 12px !important;
            margin: 8px 0 !important;
            box-shadow: none !important;
            width: 100% !important;
        }

        .swal2-actions .swal2-confirm {
            background-color: #3498db !important;
            border-radius: 20px !important;
            padding: 12px 24px !important;
        }

        .swal2-actions .swal2-deny {
            background-color: #e74c3c !important;
            border-radius: 20px !important;
        }

        .swal2-actions .swal2-cancel {
            background-color: #95a5a6 !important;
            border-radius: 20px !important;
        }

        /* Estilos base del calendario */
        .fc {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            padding: 20px;
        }
    
        /* Cabecera del calendario */
        .fc-toolbar-title {
            color: #2c3e50;
            font-weight: 600 !important;
            text-transform: capitalize;
        }
    
        /* Botones */
        .fc-button-primary {
            background-color: #3498db !important;
            border-color: #3498db !important;
            text-transform: capitalize;
            border-radius: 20px !important;
            padding: 8px 16px !important;
            transition: all 0.3s ease !important;
        }
    
        .fc-button-primary:hover {
            background-color: #2980b9 !important;
            transform: translateY(-1px);
        }
    
        /* Días */
        .fc-day {
            transition: all 0.2s ease;
        }
    
        .fc-day:hover {
            background-color: #f8f9fa !important;
        }
    
        .fc-day-today {
            background-color: #e8f4f8 !important;
        }
    
        /* Eventos */
        .fc-event {
            border: none !important;
            border-radius: 4px !important;
            padding: 3px 5px !important;
            margin: 2px !important;
            transition: all 0.3s ease !important;
        }
    
        .fc-event:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    
        .fc-event-title {
            font-weight: 500;
            padding: 2px 4px;
        }
    
        /* Responsive */
        @media (max-width: 768px) {
            .fc-toolbar.fc-header-toolbar {
                display: flex;
                flex-direction: column;
                gap: 0.8rem;
            }
    
            .fc-toolbar-title {
                font-size: 1.3em !important;
                margin: 0.5rem 0 !important;
            }
    
            .fc-button {
                padding: 6px 12px !important;
                font-size: 0.9em !important;
            }
    
            .fc-toolbar-chunk {
                display: flex;
                justify-content: center;
                width: 100%;
                gap: 0.5rem;
            }
        }
    
        /* Ajustes para pantallas muy pequeñas */
        @media (max-width: 480px) {
            .fc {
                padding: 10px;
            }
    
            .fc-toolbar-title {
                font-size: 1.1em !important;
            }
    
            .fc-button {
                padding: 4px 8px !important;
                font-size: 0.85em !important;
            }
        }
    </style>
</head>
<body>
    <div layout:fragment="content">
        <div class="card">
            <div class="card-body">
                <div id="calendario"></div>
            </div>
        </div>
    
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                var calendarEl = document.getElementById('calendario');
                var calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    locale: 'es',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    editable: true,
                    selectable: true,
                    eventDisplay: 'block',
                    displayEventTime: false,
                    eventDidMount: function(info) {
                        info.el.style.backgroundColor = info.event.backgroundColor || info.event.extendedProps.color;
                        info.el.style.borderColor = info.event.backgroundColor || info.event.extendedProps.color;
                    },
                    eventContent: function(arg) {
                        return {
                            html: `
                                <div class="fc-event-main-frame">
                                    <div class="fc-event-title-container">
                                        <div class="fc-event-title">${arg.event.title}</div>
                                    </div>
                                </div>
                            `
                        };
                    },
                    select: function(info) {
                        Swal.fire({
                            title: 'Crear Evento',
                            html: `
                                <div class="mb-3">
                                    <label class="form-label">Título:</label>
                                    <input id="swal-title" class="swal2-input" placeholder="Título">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Descripción:</label>
                                    <textarea id="swal-description" class="swal2-textarea" placeholder="Descripción"></textarea>
                                </div>
                                <div class="mb-3">
    <label class="form-label">Fecha inicio:</label>
    <input id="swal-start" type="date" class="swal2-input" value="${info.startStr.split('T')[0]}">
</div>
<div class="mb-3">
    <label class="form-label">Fecha fin:</label>
    <input id="swal-end" type="date" class="swal2-input" value="${(info.endStr || info.startStr).split('T')[0]}">
</div>
                                <div class="mb-3">
                                    <label class="form-label">Color:</label>
                                    <select id="swal-color" class="swal2-input">
                                        <option value="#3498db">Azul</option>
                                        <option value="#e74c3c">Rojo</option>
                                        <option value="#2ecc71">Verde</option>
                                        <option value="#f1c40f">Amarillo</option>
                                    </select>
                                </div>
                            `,
                            showCancelButton: true,
                            confirmButtonText: 'Guardar',
                            cancelButtonText: 'Cancelar',
                            preConfirm: () => {
                                const title = document.getElementById('swal-title').value;
                                const description = document.getElementById('swal-description').value;
                                const color = document.getElementById('swal-color').value;
                                const start = document.getElementById('swal-start').value;
                                const end = document.getElementById('swal-end').value;
                                
                                if (!title) {
                                    Swal.showValidationMessage('Por favor ingrese un título');
                                    return false;
                                }

                                return {
                                    title: title,
                                    description: description,
                                    color: color,
                                    start: start,
                                    end: end || start
                                }
                            }
                        }).then((result) => {
                            if (result.isConfirmed) {
                                fetch('/calendario/eventos', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(result.value)
                                })
                                .then(response => {
                                    if (!response.ok) throw new Error('Error en la respuesta del servidor');
                                    return response.json();
                                })
                                .then(eventoGuardado => {
                                    calendar.addEvent(eventoGuardado);
                                    Swal.fire('¡Éxito!', 'Evento guardado correctamente', 'success');
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    Swal.fire('Error', 'No se pudo guardar el evento', 'error');
                                });
                            }
                        });
                    },
                    eventClick: function(info) {
                        Swal.fire({
                            title: 'Gestionar Evento',
                            html: `
                                <div class="mb-3">
                                    <label class="form-label">Título:</label>
                                    <input id="edit-title" class="swal2-input" value="${info.event.title}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Descripción:</label>
                                    <textarea id="edit-description" class="swal2-textarea">${info.event.extendedProps.description || ''}</textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Color:</label>
                                    <select id="edit-color" class="swal2-input">
                                        <option value="#3498db">Azul</option>
                                        <option value="#e74c3c">Rojo</option>
                                        <option value="#2ecc71">Verde</option>
                                        <option value="#f1c40f">Amarillo</option>
                                    </select>
                                </div>
                            `,
                            showDenyButton: true,
                            showCancelButton: true,
                            confirmButtonText: 'Guardar',
                            denyButtonText: 'Eliminar',
                            cancelButtonText: 'Cancelar'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                const eventoActualizado = {
                                    id: info.event.id,
                                    title: document.getElementById('edit-title').value,
                                    description: document.getElementById('edit-description').value,
                                    color: document.getElementById('edit-color').value,
                                    start: info.event.startStr,
                                    end: info.event.endStr
                                };

                                fetch(`/calendario/eventos/${info.event.id}`, {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(eventoActualizado)
                                })
                                .then(response => {
                                    if (!response.ok) throw new Error('Error al actualizar');
                                    return response.json();
                                })
                                .then(updated => {
                                    info.event.setProp('title', updated.title);
                                    info.event.setExtendedProp('description', updated.description);
                                    info.event.setProp('backgroundColor', updated.color);
                                    Swal.fire('¡Éxito!', 'Evento actualizado correctamente', 'success');
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    Swal.fire('Error', 'No se pudo actualizar el evento', 'error');
                                });
                            } else if (result.isDenied) {
                                fetch(`/calendario/eventos/${info.event.id}`, {
                                    method: 'DELETE'
                                })
                                .then(response => {
                                    if (!response.ok) throw new Error('Error al eliminar');
                                    info.event.remove();
                                    Swal.fire('Eliminado', 'El evento ha sido eliminado', 'success');
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    Swal.fire('Error', 'No se pudo eliminar el evento', 'error');
                                });
                            }
                        });
                    },
                    events: '/calendario/eventos'
                });
                calendar.render();
            });
        </script>

        <!-- Add Back Button -->
    <div class="mb-3">
        <a th:href="@{/}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Volver
        </a>
    </div>
    
    </div>
</body>
</html>